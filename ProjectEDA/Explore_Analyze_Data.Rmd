---
title: "Exploratory Data Analysis"
author: "Andres Guijarro"
date: "September 12, 2017"
output: 
      html_document:
        css: mystyle.css
---

Introduction
========================================================

> **Prosper**:  is the country's first peer-to-peer lending marketplace. The 
company has provided more than $2,000,000,000 in loans. Loan interest rates 
range from 5.99% for the most credit worthy borrowers to 36.00% APR for 
consumers with lower credit ratings.  Borrowers can obtain loans from $2,000 up 
to $35,000. 

* **Financialand social rewards:**  As a peer-to-peer lending site, Prosper 
allows individuals and groups to lend money to their peers. Lenders reap both 
social and financial benefits from lending as well as greater returns than they 
would receive from a bank. This encourages people to fund loan requests. 
Borrowers understand that their loan is funded by other peers, not a traditional 
banking institution.

* **Easy rate retrieval:** Customers quickly find out their loan interest rate 
by providing basic information online. Those borrowers with higher credit scores 
typically receive lower interest rates.

* **Simple funding process:** Customers quickly find out their loan interest 
rate by providing basic information online. Those borrowers with higher credit 
scores typically receive lower interest rates.

* **No collateral required:** Borrowers from Prosper donâ€™t need collateral in 
order to qualify for a loan. Their funding is based on credit history as well as 
a few additional criteria.

* **Reputation:** Prosper is Americas first peer-to-peer lending company and has 
a reputation for being a trustworthy and dependable personal loan company.

Best for People looking to refinance debt, individuals starting a business, 
consumers facing financial hardship and those looking to finance a major life 
event. Source (https://www.consumeraffairs.com/finance/prosper.html)

> As a potential data scientist, I will explore the data about borrower market 
to learn about the borrowers behavior, loan demographic segmentation, and the 
performance of Prosper in terms of the volume of listings by year and by area.

Data Set Option
========================================================

> **Loan Data from Prosper**: Last update: 03/11/2014. This data set contains 
113,937 loans with 81 variables on each loan, including loan amount, borrower 
rate (or interest rate), current loan status, borrower income, borrower 
employment status, borrower credit history, and the latest payment information.

> To learn more about the data please visit this variable dictionary which 
explains the variables in the data set. https://goo.gl/m9hNi4

Research Questions
========================================================

* Analyzing loan bussiness in Prosper to understand the loan market by year, by 
usage of loan and by states

* Exploring the relationships between numeric variables and how them affects 
each others.

Analysis
========================================================

> **Packages requiered**: These packages are requiered for this EDA. To install, 
please execute the following code.

* install.packages("knitr", dependencies = T)
* install.packages("devtools", dependencies = T)
* install.packages("dplyr", dependencies = T)
* install.packages("ggplot2", dependencies = T)
* install.packages("RColorBrewer", dependencies = T) 
* install.packages('ggthemes', dependencies = TRUE) 
* install.packages('alr3', dependencies = TRUE)
* install.packages('tidyr', dependencies = TRUE)
* install.packages('reshape2', dependencies = TRUE)
* install.packages('reshape', dependencies = TRUE)
* require(devtools)
* install_github('ramnathv/rCharts@dev')
* install_github('ramnathv/rMaps')
* install.packages("amps", dependencies = T)
* install.packages("corrplot", dependencies = T)


```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using in your analysis in this code
# chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk. This
# prevents the code from displaying in the knitted HTML output. You should set
# echo=FALSE for all code chunks in your file, unless it makes sense for your
# report to show the code that generated a particular plot.

# The other parameters for "message" and "warning" should also be set to FALSE
# for other code chunks once you have verified that each plot comes out as you
# want it to. This will clean up the flow of your report.


library("devtools")
library("ggplot2")
library("knitr")
library("dplyr")
library("RColorBrewer")
library("ggthemes")
library("alr3")
library("tidyr")
library("reshape2")
library("reshape")
library("maps")
library("corrplot") 

```

```{r echo=FALSE, Load_the_Data}

# Set directory path where the data is located
setwd('/Users/aguijarro/SoftwareCode/github.com/aguijarro/R/ProjectEDA')

# Load the Data
loanData <- read.csv('prosperLoanData.csv')

```

# Retrieve or set the dimension of an object

This data set contains 113,937 loans with 81 variables.

```{r echo=FALSE}

# Get dim data
dim(loanData)

```

The data set includes different kind of variables like loan amount, borrower 
rate (or interest rate), current loan status, borrower income, borrower 
employment status, borrower credit history, and the latest payment information. 
The variables are from different types. To do that I will use summary function 
which is a generic function used to produce result summaries of the results of 
various model fitting functions.

```{r echo=FALSE}

# Summary data
summary(loanData)

```

# Univariate Plots Section

> **Tip**: In this section, what I want to find are some geographic and 
seasonals behavioral patterns. To do that, I need to create some columns related 
to dates.

```{r echo=FALSE, Prepare_Univariate_Plots_Date}
# Prepare date variables for analysis
# Transform to Date: ListingCreationDate
ListingCreationDate<-as.Date(loanData$ListingCreationDate)

# Get and Create Listing Creation Date - Years
ListingCreationYear<-format(ListingCreationDate, "%Y")
loanData$ListingCreationYear <- as.factor(as.numeric(ListingCreationYear))

# Get and Create Listing Creation Date - Months
ListingCreationMonth<-format(ListingCreationDate, "%m")
loanData$ListingCreationMonth <- as.factor(as.numeric(ListingCreationMonth))

# Get and Create Listing Creation Date - Days
ListingCreationDay<-format(ListingCreationDate, "%d")
loanData$ListingCreationDay <- as.factor(as.numeric(ListingCreationDay))

```

## Listing by Geography Location
### Listing By Borrower State
> As we can observe, there are loans spread out around all country. This could 
mean that the company has network office distribute around the country, or maybe 
it offer a website which is known and accessed from every country. Also, this 
could mean that the company has a good reputation and confidence, so people 
around the country demands its services.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots_Location}

data(state)

states <- data.frame(state.abb, state.name, state.area, state.center, state.division, state.region, state.x77)

states <- rename(states, c("x"          = "state.x", 
"y"          = "state.y", 
"Population" = "state.population",
"Income"     = "state.income",
"Illiteracy" = "state.illiteracy",
"Life.Exp"   = "state.life.exp",
"Murder"     = "state.murder",
"HS.Grad"    = "state.hs.grad",
"Frost"      = "state.frost",
"state.abb"  = "BorrowerState"))

# Merge spurce data, state data 
loanData <- merge(loanData, states, by=c("BorrowerState"))

# colnames(loanData)

ggplot(aes(x=state.x, y=state.y), data=loanData) +
geom_point() 

map <- map_data("state")
states <- subset(states, ! state.abb %in% c("HI", "AK"))

ggplot(data = map, aes(x = long, y = lat, group = group)) +
# draw outlines of the state
geom_polygon() + 
geom_path(colour = 'gray', linestyle = 2) + 
coord_map() +
# state.x and state.y = center of each state, where we plot its abbreviation
geom_text(data = states, aes(x     = state.x, 
y     = state.y, 
label = BorrowerState,
group = NULL), 
size = 4, 
colour="white") +
# us loans
geom_jitter(data=loanData,aes(x=state.x, y=state.y, group=NULL), colour="yellow",alpha=0.8 ) 

```


## Group data by BorrowerState
> Even though the loans are around the country, there are some states which have 
more number of loans than others. The table and the graph below show the top 
five states with the higher amount of loans. In order descendent order these 
states are: California, Texas, New York, Florida, and Illinois.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univ_Plots_Loc_Gpr_Bor_Sta_Md1}
loanData.grp_borrower_state <- loanData %>%
group_by(BorrowerState, tolower(state.name)) %>%
summarize(LoanOriginalAmount_mean = mean(LoanOriginalAmount),
LoanOriginalAmount_median = median(LoanOriginalAmount),
n = n()) %>%
arrange(desc(n))


loanData.grp_borrower_state <- rename(loanData.grp_borrower_state, c("tolower(state.name)" = "state.name"))

loanData.grp_borrower_state <- loanData.grp_borrower_state[1:5,]


writeLines("td, th { padding : 6px } th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown }", con = "mystyle.css")
knitr::kable(loanData.grp_borrower_state, format = "html")

map1 <- map_data("state")
map1 <- merge(map1, loanData.grp_borrower_state, by.x = c("region"), 
by.y=c("state.name"), all.x=TRUE)
map1 <- arrange(map1, order)

ggplot(data = map1, aes(x = long, y = lat, group = group)) +
geom_polygon(aes(fill = n)) +
coord_map() +
# state.x and state.y = center of each state, where we plot its abbreviation
geom_text(data = states, aes(x     = state.x, 
y     = state.y, 
label = BorrowerState,
group = NULL), size = 4, colour="white") +
scale_fill_distiller(palette = "Spectral") +
theme_bw()
```

> Althought the number of loans are important, more important is the amount of 
money these loans produced. So, let's identify which states makes more money. 
As you can see the top five states which more money produced are: Texas, 
California, New York, Illinois, and Florida. 

```{r echo=FALSE, message=FALSE, warning=FALSE, Univ_Plots_Loc_Gpr_Bor_Sta_Md2}


loanData.grp_borrower_state <-arrange(loanData.grp_borrower_state, desc(LoanOriginalAmount_mean))

writeLines("td, th { padding : 6px } th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown }", con = "mystyle.css")
knitr::kable(loanData.grp_borrower_state, format = "html")


ggplot(data = map1, aes(x = long, y = lat, group = group)) +
geom_polygon(aes(fill = LoanOriginalAmount_mean)) +
coord_map() +
# state.x and state.y = center of each state, where we plot its abbreviation
geom_text(data = states, aes(x     = state.x, 
y     = state.y, 
label = BorrowerState,
group = NULL), size = 4, colour="white") +
scale_fill_distiller(palette = "Spectral") +
theme_bw()

```


## Listing creation in prosper by time

### Listing Creation Date - Year
> Once I have a interesting idea about loan geographic segmentation, now I want 
to determine how loans evolved during the time. In the first graphic below, I 
can observe that two years (2006 and 2009) the loans were very low.  Probably 
the first year (2006) was the beginning of the company, and the second there 
was something problem in the economy. During the other years, the amount of 
loans were growing because of Economy recovery. The other two graphics show us 
a constant value in the amount of money required in the loans.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots_Date_Year}

qplot(data = loanData, x = ListingCreationYear, color = I('black'), fill = I('#00ccff'))

ggplot(aes(x = ListingCreationYear , y = LoanOriginalAmount ), data = loanData) + 
  geom_bar(stat = "identity")

ggplot(aes(x = ListingCreationYear , y = LoanOriginalAmount ), data = loanData) + 
  geom_bar(stat = "identity") +
  ylim(0, quantile(loanData$LoanOriginalAmount, 0.95))

```

### Listing Creation Date - Month
> Even though there are some years with more amount of loans (2013), I can not 
observe a seasonal behavior per month in a year. This could mean that people 
need money not for a specific reason like Holidays.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots_Date_Months}

qplot(data = loanData, x = ListingCreationMonth, color = I('black'), fill = I('#00ccff')) + 
  scale_x_discrete(breaks=1:12) +
  facet_wrap(~ListingCreationYear, ncol=3)

```

### Listing Creation Date - Day
> As the same of months behavior, we cannot observe in a clear way a seasonal 
behavior in the days of each month.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots_Date_Days}

qplot(data = loanData, x = ListingCreationDay, color = I('black'), fill = I('#00ccff')) + 
  scale_x_discrete(breaks=01:31) +
  facet_wrap(~ListingCreationMonth, ncol=3)

```


### Listing by Category 
> To complete this first analysis, I want to discoverer the principal reason why 
people get a loan. To do that, I will analyse the category of the listing that 
the borrower selected when posting their listing. Because this variable is 
numeric, I attached here the meaning of each number:  0 - Not Available, 
1 - Debt Consolidation, 2 - Home Improvement, 3 - Business, 4 - Personal Loan, 
5 - Student Use, 6 - Auto, 7- Other, 8 - Baby&Adoption, 9 - Boat, 
10 - Cosmetic Procedure, 11 - Engagement Ring, 12 - Green Loans, 13 - Household 
Expenses, 14 - Large Purchases, 15 - Medical/Dental, 16 - Motorcycle, 
17 - RV, 18 - Taxes, 19 - Vacation, 20 - Wedding Loans

> In the first graph, we can observe that the principal reason to make a loan 
during the years are the category 0 (Not Available), however if we limit to get 
the quantile 0.95 in the y axis, the principal columns are 0 (Not Available) 
and 7 (Other). We can also confirm this pattern in the second graphics where I 
split the data also for Term. It is totally clear that these reasult don't give 
as much information, also we can mention that the dataset could be improve in 
this variable. Considering the next result, the most important categories are: 
2 (Home Improvement) and 3 (Business). 

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots_Categoria}

qplot(data = loanData, x = ListingCategory..numeric., binwidth = 1, color = I('black'), fill = I('#00ccff')) + 
  scale_x_continuous(breaks=0:20) +
  facet_wrap(~ListingCreationYear, ncol=3) +
  xlim(0, quantile(loanData$ListingCategory..numeric., 0.95)) 

qplot(data = loanData, x = ListingCategory..numeric., binwidth = 1, color = I('black'), fill = I('#00ccff')) + 
  scale_x_continuous(breaks=0:20) +
  facet_grid(Term ~ .) +
  xlim(0, quantile(loanData$ListingCategory..numeric., 0.95)) 

qplot(data = loanData, x = ListingCategory..numeric., binwidth = 1, color = I('black'), fill = I('#099DD9')) +
  scale_x_continuous(breaks = 0:20) +
  ylim(0, quantile(loanData$LoanOriginalAmount, 0.95))

```

> Finally, we can determine about categories is that the amount of data is very 
regular in most of the categories.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots_Categoria_1}

ggplot(aes(x = ListingCategory..numeric. , y = LoanOriginalAmount ), data = loanData) + 
  geom_bar(stat = "identity", color = I('#00ccff')) +
  scale_x_continuous(breaks = 0:20) +
  xlim(0, quantile(loanData$ListingCategory..numeric., 0.95)) +
  ylim(0, quantile(loanData$LoanOriginalAmount, 0.95))

```

# Univariate Analysis

### What is the structure of your dataset?

> This data set contains 113,937 loans with 81 variables. The data set includes 
different kind of variables like loan amount, borrower rate (or interest rate), 
current loan status, borrower income, borrower employment status, borrower 
credit history, and the latest payment information. The variables are from 
different types. To do that I will use summary function which is a generic 
function used to produce result summaries of the results of various model 
fitting functions.

### What is/are the main feature(s) of interest in your dataset?

> The most important features are:

* LoanOriginalAmount
* MonthlyLoanPayment

### What other features in the dataset do you think will help support your \
analysis?

> The help support features are:

* ListingCreationYear
* ListingCreationMonth
* ListingCreationDay
* Term
* ListingCategory..numeric.
* EmploymentStatus
* LoanStatus
* BorrowState

### Did you create any new variables from existing variables in the dataset?

> To analyze how loans behave during the time I created three columns: 
ListingCreationYear, ListingCreationMonth, and ListingCreationDay . 


### Of the features you investigated, were there any unusual distributions? \

No features has unsual distributions.

# Bivariate Plots Section

> In this bivariate analysis, what I want to find are common variable 
relationships according with some ideas about the loan business I have. 
In that order, I think the following list are natural relationships in 
loan business.

**LoanOriginalAmount vs MonthlyLoanPayment** -> Higher loan amount, 
higher monthly payment.

**LoanOriginalAmount vs Investors** -> Higher loan amount, 
higher number of investors.

**EstimatedReturn vs Investors** -> Higher estimated return, higher investors.

**LoanOriginalAmount vs EmploymentStatusDuration** -> Higher loan amount, 
higher employment status duration.

**BankcardUtilization vs LoanOriginalAmount** -> Higher bankcard utilization, 
higher loan amount.

## LoanOriginalAmount vs MonthlyLoanPayment
> The correlation between these two variables are strong positive. It means that 
higher loan amount result in  higher monthly payment.

```{r echo=FALSE, message=FALSE, warning=FALSE, LoanOriginalAmountMonthlyLoanPayment}

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point() + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(0, quantile(loanData$MonthlyLoanPayment, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("Loan Original Amount") + 
  ylab("Monthly Loan Payment")

# Strong positive correlation
with(loanData, cor.test(LoanOriginalAmount, MonthlyLoanPayment, method = 'pearson'))

```

## LoanOriginalAmount vs Investors
> Even though it exists correlation between these two variables, it is not 
strong. It means that it is not complete true that higher loan amount imply 
higher number of investors.

```{r echo=FALSE, message=FALSE, warning=FALSE, LoanOriginalAmountInvestors}

ggplot(aes(x = LoanOriginalAmount, y = Investors), data = loanData) +
  geom_point() + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(0, quantile(loanData$Investors, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("Loan Original Amount") + 
  ylab("Investors")

# Strong positive correlation
with(loanData, cor.test(LoanOriginalAmount, Investors, method = 'pearson'))

```

## EstimatedReturn vs Investors
>  The are not correlation between these two variables because the coefficient 
are very close to 0.

```{r echo=FALSE, message=FALSE, warning=FALSE, EstimatedReturnInvestors}

ggplot(aes(x = EstimatedReturn, y = Investors), data = subset(loanData,!is.na(EstimatedReturn) & !is.na(Investors))) +
  geom_point() + 
  geom_smooth(method = 'lm', color = 'red') +
  xlab("EstimatedReturn") + 
  ylab("Investors")

# Get correlation
with(loanData, cor.test(EstimatedReturn, Investors, method = 'pearson'))

```

## LoanOriginalAmount vs EmploymentStatusDuration
> The are not correlation between these two variables because the coefficient 
are very close to 0.

```{r echo=FALSE, message=FALSE, warning=FALSE, LoanOriginalAmountEmploymentStatusDuration}

ggplot(aes(x = LoanOriginalAmount, y = EmploymentStatusDuration), data = loanData) +
  geom_point() + 
  geom_smooth(method = 'lm', color = 'red') +
  xlab("LoanOriginalAmount") + 
  ylab("EmploymentStatusDuration")

# Get correlation
with(loanData, cor.test(LoanOriginalAmount, EmploymentStatusDuration, method = 'pearson'))
```

## BankcardUtilization vs LoanOriginalAmount
> The are not correlation between these two variables because the coefficient 
are very close to 0.

```{r echo=FALSE, message=FALSE, warning=FALSE, BankcardUtilizationLoanOriginalAmount}

ggplot(aes(x = LoanOriginalAmount, y = BankcardUtilization), data = loanData) +
  geom_point() + 
  geom_smooth(method = 'lm', color = 'red') +
  xlab("LoanOriginalAmount") + 
  ylab("BankcardUtilization")

# Get correlation
with(loanData, cor.test(LoanOriginalAmount, BankcardUtilization, method = 'pearson'))

```

> Because just one scatter plot show a strong correlation, it is important to 
define another strategy to identify variable relationships. Also, it is 
important to mention that people can have some ideas about business which not 
really are true because of ignorance in that field. For that reason, it is 
important to be objective when we analyce data.

## New Strategy
> To improve the variables selection, I am going to calculate the correlation 
between all numeric variables. In order to achieve this activity, I will modify 
the data set to maintain only numeric data, and then change column names. 

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots20}
# Get only numeric data
loandData.numeric <- select_if(loanData, is.numeric)

# Remove some columns
loandData.numeric <- within(loandData.numeric, rm("LoanNumber","ListingNumber"))

# Change column names
names(loandData.numeric)[1:length(loandData.numeric)] <- sprintf("x%d", 1:length(loandData.numeric))

```

> Now, I will drop NA values, and finally I will calculate correlations and show 
them with a graphic to easy understanding.

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
# Remove na values
loandData.numeric.na <- loandData.numeric %>% drop_na()

# Get correlations
loandData.numeric.cor <- round(cor(loandData.numeric.na),2)

# Display correlations
#writeLines("table { table-layout: fixed; width: 100%; /* must have this set */; font-size : 6px;} td, th { padding : 1px} th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown}", con = "mystyle.css")
#knitr::kable(loandData.numeric.cor, format = "html")
loandData.numeric.cor

# Graphics correlations
corrplot(loandData.numeric.cor, method="square",is.corr=FALSE,type="full", tl.cex=0.5, diag = FALSE, tl.offset = 1, cl.length = 20, col = colorRampPalette(c("midnightblue", "white","darkred"))(100))

```

> As result, the data which have a good correlation coefficient are:

  * 1) BorrowerRate - BorrowerAPR ---> 0.989824                           
  * 2) LenderYield - BorrowerAPR --->  0.9893289    
  * 3) LenderYield - BorrowerRate ---> 0.9992113                              
  * 4) EstimatedLoss -> BorrowerAPR ---> 0.9495375   
  * 5) EstimatedLoss -> BorrowerRate ---> 0.945297                         
  * 6) EstimatedLoss - LenderYield ---> 0.9453084 
  * 7) EstimatedReturn -> EstimatedEffectiveYield ---> 0.8015679             
  * 8) ProsperRating..numeric. - BorrowerAPR ---> -0.9621513  
  * 9) ProsperRating..numeric. - BorrowerRate ---> -0.9531049
  * 10) ProsperRating..numeric. -> LenderYield ---> -0.9531194  
  * 11) ProsperRating..numeric. - EstimatedLoss ---> -0.9641819             
  * 12) CreditScoreRangeUpper - CreditScoreRangeLower --->  1 
  * 13) OpenCreditLines -> CurrentCreditLines ---> 0.9604087               
  * 14) OpenRevolvingAccounts - CurrentCreditLines ---> 0.8526853       
  * 15) OpenRevolvingAccounts - OpenCreditLines ---> 0.8854484              
  * 16) TotalInquiries - InquiriesLast6Months ---> 0.7419499 
  * 17) RevolvingCreditBalance - penRevolvingMonthlyPayment ---> 0.7609608  
  * 18) TotalTrades - TotalCreditLinespast7years ---> 0.9364824
  * 19) TotalTrades - OpenCreditLines ---> 0.6356007                         
  * 20) TotalProsperPaymentsBilled - TotalProsperLoans ---> 0.7038035       
  * 21) OnTimeProsperPayments - TotalProsperLoans ---> 0.7029944
  * 22) OnTimeProsperPayments - TotalProsperPaymentsBilled ---> 0.9903052    
  * 23) MonthlyLoanPayment - LoanOriginalAmount ---> 0.9319837 
  * 24) LP_CustomerPrincipalPayments - LP_CustomerPayments ---> 0.97743
  * 25) LP_InterestandFees - LP_CustomerPayments ---> 0.6871885
  * 29) LP_ServiceFees - LoanOriginalAmount ---> -0.483367                  
  * 30) LP_ServiceFees - MonthlyLoanPayment ---> -0.4620533
  * 31) LP_ServiceFees - LP_CustomerPayments ---> -0.7031245                 
  * 32) LP_ServiceFees - LP_CustomerPrincipalPayments ---> -0.5769329 
  * 33) LP_ServiceFees - LP_InterestandFees ---> -0.8625553 

> In that order, the new variables chosen to analyze the correlation are:

##  MonthlyLoanPayment - LoanOriginalAmount
> The correlation between these two variables are strong positive. It means that 
higher loan amount result in  higher monthly payment.
                     
```{r echo=FALSE, message=FALSE, warning=FALSE, MonthlyLoanPaymentLoanOriginalAmount}

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point() + 
  xlim(1000, 35000)

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_jitter(alpha = 1/20) + 
  xlim(1000, 35000)

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(alpha = 1/20, position = position_jitter(h = 0)) + 
  xlim(1000, 35000) + 
  coord_trans(y = 'sqrt')

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point() + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(0, quantile(loanData$Investors, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("Loan Original Amount") + 
  ylab("Monthly Loan Payment")


# Strong positive correlation

with(loanData, cor.test(LoanOriginalAmount, MonthlyLoanPayment, method = 'pearson'))

```


##  LP_ServiceFees - LoanOriginalAmount
> The correlation between these two variables are strong positive. It means that 
higher loan amount result in  less  LP_ServiceFees.

```{r echo=FALSE, message=FALSE, warning=FALSE, LP_ServiceFeesLoanOriginalAmount}

ggplot(aes(x = LoanOriginalAmount, y = LP_ServiceFees), data = loanData) +
  geom_point() + 
  xlim(1000, 35000)

ggplot(aes(x = LoanOriginalAmount, y = LP_ServiceFees), data = loanData) +
  geom_jitter(alpha = 1/20) + 
  xlim(1000, 35000)

ggplot(aes(x = LoanOriginalAmount, y = LP_ServiceFees), data = loanData) +
  geom_point() + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(-664.90, quantile(loanData$LP_ServiceFees, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("LoanOriginal Amount") + 
  ylab("LP_ServiceFees")

# Strong positive correlation

with(loanData, cor.test(LoanOriginalAmount, LP_ServiceFees, method = 'pearson'))

```


##  ProsperRating..numeric. - EstimatedLoss
> The correlation between these two variables are strong negative. It means that 
higher ProsperRating..numeric. result in  less  EstimatedLoss. 

```{r echo=FALSE, message=FALSE, warning=FALSE, ProsperRating..numeric.EstimatedLoss}

ggplot(data=loanData, aes(loanData$ProsperRating..Alpha., loanData$EstimatedLoss)) + 
  geom_boxplot() 

ggplot(data=loanData, aes(ProsperRating..Alpha., EstimatedLoss, fill=ProsperRating..Alpha.)) + 
  geom_boxplot(outlier.shape = NA) +
  ylim(0, quantile(loanData$EstimatedLoss, 0.95, na.rm = TRUE)) +
  labs(title="Prosper Rating vs Estimated Loss") + 
  xlab("Prosper Rating") + 
  ylab("Estimated Loss") +
  guides(fill=guide_legend(title=NULL))


# Strong positive correlation
with(loanData, cor.test(ProsperRating..numeric., EstimatedLoss, method = 'pearson'))

```


# Bivariate Analysis


### Talk about some of the relationships you observed in this part of the \
investigation. How did the feature(s) of interest vary with other features in \
the dataset?

>  The list below show the initial relationships I thought were natural. 
However, most of these variables are not correlated each other.

**LoanOriginalAmount vs MonthlyLoanPayment** -> Higher loan amount, 
higher monthly payment.

**LoanOriginalAmount vs Investors** -> Higher loan amount, 
higher number of investors.

**EstimatedReturn vs Investors** -> Higher estimated return, higher investors.

**LoanOriginalAmount vs EmploymentStatusDuration** -> Higher loan amount, 
higher employment status duration.

**BankcardUtilization vs LoanOriginalAmount** -> Higher bankcard utilization, 
higher loan amount.

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

> In order to identify more useful relationships, I calculate the correlation 
coefficient between all variables and I find the following list:

  * 1) BorrowerRate - BorrowerAPR ---> 0.989824                           
  * 2) LenderYield - BorrowerAPR --->  0.9893289    
  * 3) LenderYield - BorrowerRate ---> 0.9992113                              
  * 4) EstimatedLoss -> BorrowerAPR ---> 0.9495375   
  * 5) EstimatedLoss -> BorrowerRate ---> 0.945297                         
  * 6) EstimatedLoss - LenderYield ---> 0.9453084 
  * 7) EstimatedReturn -> EstimatedEffectiveYield ---> 0.8015679             
  * 8) ProsperRating..numeric. - BorrowerAPR ---> -0.9621513  
  * 9) ProsperRating..numeric. - BorrowerRate ---> -0.9531049
  * 10) ProsperRating..numeric. -> LenderYield ---> -0.9531194  
  * 11) ProsperRating..numeric. - EstimatedLoss ---> -0.9641819             
  * 12) CreditScoreRangeUpper - CreditScoreRangeLower --->  1 
  * 13) OpenCreditLines -> CurrentCreditLines ---> 0.9604087               
  * 14) OpenRevolvingAccounts - CurrentCreditLines ---> 0.8526853       
  * 15) OpenRevolvingAccounts - OpenCreditLines ---> 0.8854484              
  * 16) TotalInquiries - InquiriesLast6Months ---> 0.7419499 
  * 17) RevolvingCreditBalance - penRevolvingMonthlyPayment ---> 0.7609608  
  * 18) TotalTrades - TotalCreditLinespast7years ---> 0.9364824
  * 19) TotalTrades - OpenCreditLines ---> 0.6356007                         
  * 20) TotalProsperPaymentsBilled - TotalProsperLoans ---> 0.7038035       
  * 21) OnTimeProsperPayments - TotalProsperLoans ---> 0.7029944
  * 22) OnTimeProsperPayments - TotalProsperPaymentsBilled ---> 0.9903052    
  * 23) MonthlyLoanPayment - LoanOriginalAmount ---> 0.9319837 
  * 24) LP_CustomerPrincipalPayments - LP_CustomerPayments ---> 0.97743
  * 25) LP_InterestandFees - LP_CustomerPayments ---> 0.6871885
  * 29) LP_ServiceFees - LoanOriginalAmount ---> -0.483367                  
  * 30) LP_ServiceFees - MonthlyLoanPayment ---> -0.4620533
  * 31) LP_ServiceFees - LP_CustomerPayments ---> -0.7031245                 
  * 32) LP_ServiceFees - LP_CustomerPrincipalPayments ---> -0.5769329 
  * 33) LP_ServiceFees - LP_InterestandFees ---> -0.8625553

### What was the strongest relationship you found?

> There are two strongest relationships I found: 
1)  CreditScoreRangeUpper - CreditScoreRangeLower --->  1 
and the other: MonthlyLoanPayment - LoanOriginalAmount ---> 0.9319837.


# Multivariate Plots Section

> In this section, what I want to show is how affects a third support variable 
to the  relationships I found in bivariate analysis. In the first image what we 
can observe is that most of the MonthlyLoanPayment are related to 36 and 60 
months.

```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots_1}

loanData$Term <- factor(loanData$Term, levels=c(12,36,60), ordered=TRUE)

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = Term)) + 
  xlim(1000, 35000) +
  theme_bw() + labs(title="Loan Original Amount vs Monthly Loan Payment")

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = Term)) + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(0, quantile(loanData$Investors, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("Loan Original Amount") + 
  ylab("Monthly Loan Payment") +
  theme_bw() + labs(title="Loan Original Amount vs Monthly Loan Payment")

```

> Also, we can see that most of the people have an employment and an important 
number of them have a full time jobs.


```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots_2}

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = EmploymentStatus)) + 
  xlim(1000, 35000) +
  theme_bw() + labs(title="LoanOriginalAmount vs MonthlyLoanPayment")

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = EmploymentStatus)) + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(0, quantile(loanData$Investors, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("Loan Original Amount") + 
  ylab("Monthly Loan Payment") +
  theme_bw() + labs(title="LoanOriginalAmount vs MonthlyLoanPayment")

```

> Then, we can see that a great number of loans were complete, however there are 
an important number which are currently opened.


```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots_3}

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = LoanStatus)) + 
  xlim(1000, 35000) +
  theme_bw() + labs(title="LoanOriginalAmount vs MonthlyLoanPayment")

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = LoanStatus)) + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(0, quantile(loanData$Investors, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("Loan Original Amount") + 
  ylab("Monthly Loan Payment") +
  theme_bw() + labs(title="LoanOriginalAmount vs MonthlyLoanPayment")

```

> Also it is important to mention that most of the loans have a Rate A, AA, and 
B which means that the portfolio of the company does not have a higher risk.


```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots_4}

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = ProsperRating..Alpha.)) + 
  xlim(1000, 35000) +
  theme_bw() + labs(title="LoanOriginalAmount vs MonthlyLoanPayment")

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = ProsperRating..Alpha.)) + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(0, quantile(loanData$Investors, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("Loan Original Amount") + 
  ylab("Monthly Loan Payment") +
  theme_bw() + labs(title="LoanOriginalAmount vs MonthlyLoanPayment")

```

> Finally, we can observe that the principal income of range from people who ask 
a loan is around $25000 to $75000.


```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots_5}

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = IncomeRange)) + 
  xlim(1000, 35000) +
  theme_bw() + labs(title="LoanOriginalAmount vs MonthlyLoanPayment")

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = loanData) +
  geom_point(aes(color = IncomeRange)) + 
  xlim(1000, quantile(loanData$LoanOriginalAmount, 0.95)) + 
  ylim(0, quantile(loanData$Investors, 0.95)) +
  geom_smooth(method = 'lm', color = 'red') +
  xlab("Loan Original Amount") + 
  ylab("Monthly Loan Payment") +
  theme_bw() + labs(title="LoanOriginalAmount vs MonthlyLoanPayment")

```


> Also, what I can observe in the following graph is that the MonthlyLoanPayment 
month mean increase according with the EmploymentStatusDuration, however the 
term no depends of the amount on MonthlyLoanPayment or EmploymentStatusDuration.

```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots_6}

loanData.tempo <- loanData %>%
  filter(!is.na(EmploymentStatusDuration))

loanData.grp_term_empStatus <- loanData %>%
  filter(!is.na(EmploymentStatusDuration)) %>%
  group_by(Term, EmploymentStatusDuration) %>%
  summarize(MonthlyLoanPayment_mean = mean(MonthlyLoanPayment),
          MonthlyLoanPayment_median = median(MonthlyLoanPayment),
          n = n()) %>%
  ungroup() %>%
  arrange(Term)

ggplot(aes(x = EmploymentStatusDuration, y = MonthlyLoanPayment_mean), data = loanData.grp_term_empStatus) + geom_line(aes(color = Term )) +
   xlim(0, quantile(loanData$EmploymentStatusDuration, 0.95, na.rm = TRUE)) +
   ylim(0, quantile(loanData$MonthlyLoanPayment_mean, 0.95, na.rm = TRUE)) + 
  xlab("Employment Status Duration") + 
  ylab("Monthly Loan Payment") +
  labs(title="Employment Status Duration vs Monthly Loan Payment")

```


> In addition, what I can observe in the following graph is that the 
MonthlyLoanPayment month mean increase in two categories of Listing meanwhile 
in the others are constant. Also, there is a very lower value in one category. 
Again, the term no depends of the amount on MonthlyLoanPayment or Listing 
category.

```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots_7}

loanData.ListingCategory <- loanData %>%
  filter(!is.na(ListingCategory..numeric.))

loanData.grp_term_ListingCategory <- loanData %>%
  filter(!is.na(ListingCategory..numeric.)) %>%
  group_by(Term, ListingCategory..numeric.) %>%
  summarize(MonthlyLoanPayment_mean = mean(MonthlyLoanPayment),
          MonthlyLoanPayment_median = median(MonthlyLoanPayment),
          n = n()) %>%
  ungroup() %>%
  arrange(Term)


ggplot(aes(x = ListingCategory..numeric., y = MonthlyLoanPayment_mean), data = loanData.grp_term_ListingCategory) + geom_line(aes(color = Term ), stat = "summary", fun.y = median) +
   xlim(0, quantile(loanData$ListingCategory..numeric., 0.95, na.rm = TRUE))  + 
   xlab("Listing Category") + 
   ylab("Monthly Loan Payment") +
   labs(title="Listing Category vs Monthly Payment")

ggplot(aes(x = ListingCategory..numeric., y = MonthlyLoanPayment_mean, fill=Term), data = loanData.grp_term_ListingCategory) + 
   geom_bar(position = "stack", stat = "identity") +
    xlim(0, quantile(loanData$ListingCategory..numeric., 0.95, na.rm = TRUE))  + 
   xlab("Listing Category") + 
   ylab("Monthly Loan Payment") +
   labs(title="Listing Category vs Monthly Payment") 


```


# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \

> In the first image what we can observe is that most of the MonthlyLoanPayment 
are related to 36 and 60 months. Also, we can see that most of the people have 
an employment and an important number of them have a full time jobs.Then, we can 
see that a great number of loans were complete, however there are an important 
number which are currently opened. Also it is important to mention that most of 
the loans have a Rate A, AA, and B which means that the portfolio of the company 
does not have a higher risk. Finally, we can observe that the principal income 
of range from people who ask a loan is around $25000 to $75000.


### Were there any interesting or surprising interactions between features?

> Also, what I can observe is that the MonthlyLoanPayment month mean increase 
according with the EmploymentStatusDuration, however the term no depends of the 
amount on MonthlyLoanPayment or EmploymentStatusDuration

------

# Final Plots and Summary

### Plot One

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_One}
#Prepare Data
loanData.grp_borrower_state <- loanData %>%
group_by(BorrowerState, tolower(state.name)) %>%
  summarize(LoanOriginalAmount_mean = mean(LoanOriginalAmount),
  LoanOriginalAmount_median = median(LoanOriginalAmount),
  n = n()) %>%
  arrange(desc(n))


loanData.grp_borrower_state <- rename(loanData.grp_borrower_state, c("tolower(state.name)" = "state.name"))

loanData.grp_borrower_state <- loanData.grp_borrower_state[1:5,]

map1 <- map_data("state")
map1 <- merge(map1, loanData.grp_borrower_state, by.x = c("region"), 
by.y=c("state.name"), all.x=TRUE)
map1 <- arrange(map1, order)

# Build one graph
ggplot(data = map1, aes(x = long, y = lat, group = group)) +
geom_polygon(aes(fill = n)) +
coord_map() +
# state.x and state.y = center of each state, where we plot its abbreviation
geom_text(data = states, aes(x     = state.x, 
y     = state.y, 
label = BorrowerState,
group = NULL), size = 4, colour="white") +
scale_fill_distiller(palette = "Spectral") +
theme_bw() + 
labs(title="Number of Loans per State")

loanData.grp_borrower_state <-arrange(loanData.grp_borrower_state, desc(LoanOriginalAmount_mean))

ggplot(data = map1, aes(x = long, y = lat, group = group)) +
geom_polygon(aes(fill = LoanOriginalAmount_mean)) +
coord_map() +
# state.x and state.y = center of each state, where we plot its abbreviation
geom_text(data = states, aes(x     = state.x, 
y     = state.y, 
label = BorrowerState,
group = NULL), size = 4, colour="white") +
scale_fill_distiller(palette = "Spectral") +
theme_bw() + 
labs(title="Amount of money per State")

```

### Description One

> These two maps show us that number of loans not always means more money 
required. For example, in the first map you can observe that state
which more number of loans is California (14717 loans), however the state which 
more amount of money demanded is Texas (9087.326 dollars). These graphs are very
useful bacause them show in very clear form the difference between number and
amount of money requiered. This result also could help company to determine what
kind of strategy marketing they should apply. For example, if company wants to 
have more number of customers the could develop some strategies in California, 
but if they want to put more money probably it is a better option to focus in 
Texas.

### Plot Two

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Two}

ggplot(data=loanData, aes(ProsperRating..Alpha., EstimatedLoss, fill=ProsperRating..Alpha.)) + 
  geom_boxplot(outlier.shape = NA) +
  ylim(0, quantile(loanData$EstimatedLoss, 0.95, na.rm = TRUE)) +
  labs(title="Prosper Rating vs Estimated Loss") + 
  xlab("Prosper Rating") + 
  ylab("Estimated Loss") +
  guides(fill=guide_legend(title=NULL))

```

### Description Two

> In this graph, what we can find is that prosper rating decreased while 
estimated loss increased. It means that the risk is more higher when people have
low prosper ratings. This relationship can also be validated if we calculate the 
coefficient of correlation between these two variables (-0.9641819). Moreover,
this graph is helpful because it provides a useful way to visualise the range 
and other characteristics of responses for a large group.

### Plot Three

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Three}

loanData.ListingCategory <- loanData %>%
  filter(!is.na(ListingCategory..numeric.))

loanData.grp_term_ListingCategory <- loanData %>%
  filter(!is.na(ListingCategory..numeric.)) %>%
  group_by(Term, ListingCategory..numeric.) %>%
  summarize(MonthlyLoanPayment_mean = mean(MonthlyLoanPayment),
          MonthlyLoanPayment_median = median(MonthlyLoanPayment),
          n = n()) %>%
  ungroup() %>%
  arrange(Term)


ggplot(aes(x = ListingCategory..numeric., y = MonthlyLoanPayment_mean), data = loanData.grp_term_ListingCategory) + geom_line(aes(color = Term ), stat = "summary", fun.y = median) +
   xlim(0, quantile(loanData$ListingCategory..numeric., 0.95, na.rm = TRUE))  + 
   xlab("Listing Category") + 
   ylab("Monthly Loan Payment - dollars") +
   labs(title="Listing Category vs Monthly Payment")

```

### Description Three

> What we can see in this graph is that Monthly Payment is higher when the Term
of paying is lower. This means that Monthly Payment is higher when Term is 12 
months no matter which kind of category is the loan. Also, we can see that 
Monthtly Payment is also higher when Term is 60 months. What it is important in
this graph is the ease with which it allows you to see how three variables
interacts each other.

------
  
# Reflection
  
  * To make a good analysis it is important to know about the business, meet how 
  the process is, and know what each variable means. If a person does not have 
  much experience in this field the time to analyze data could growth 
  exponentially, the analisys could not be precise, and the result could be 
  wrong. In my case, I had troubles selecting the variables and building 
  logical relationships between them. What I did to fix this issue was read 
  about the business, and try to use helpful tools to help me in my analys. One
  of this tool which corrplot which helped me to identify relationships in less 
  time.
  
  * After this work, I hope to gain more experience using r not just for EDA but
  also to predict things. I want to learn how to apply machine learning 
  algorithms with r. Also, I want to analyze different data set to gain more
  skills using r.


-------
# References

* https://goo.gl/LvVMBT
* https://goo.gl/ubgAf8
* https://goo.gl/vL5mr5
* https://goo.gl/pzhULM
* https://goo.gl/gfkrmQ
* https://goo.gl/tsTZhp
* https://goo.gl/b3NFsw




